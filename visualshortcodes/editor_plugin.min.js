(function(){tinymce.create("tinymce.plugins.visualShortcodes",{init:function(a,b){this.counter=0;var d=this,c,e,f=[];d.url=b;d._shortcodes=tinymce.i18n["visualShortcode.shortcodes"];if(!d._shortcodes||undefined===d._shortcodes.length||0==d._shortcodes.length){return}d.shortcodes={};for(c=0,e=d._shortcodes[c];c<d._shortcodes.length;e=d._shortcodes[++c]){if(undefined===e.shortcode||""==e.shortcode||undefined===e.image||""==e.image){continue}d.shortcodes[e.shortcode]=e;f.push(e.shortcode)}if(f.length<1){return}d._buildRegex(f);d._createButtons();a.onMouseDown.add(function(h,i){if(i.target.nodeName=="IMG"&&h.dom.hasClass(i.target,"jpbVisualShortcode")){var g=i.target.id.replace(/^vscImage\d+-(.+)$/,"$1");if(undefined!==d.shortcodes[g]&&undefined!==d.shortcodes[g].command){h.plugins.wordpress._showButtons(i.target,"jpb_vscbuttons")}else{h.plugins.wordpress._showButtons(i.target,"jpb_vscbutton")}}else{d._hideButtons()}});a.onChange.add(function(g,h){if(!d.regex.test(h.content)){return}h.content=d._doScImage(h.content);g.setContent(h.content);g.execCommand("mceRepaint")});a.onBeforeSetContent.add(function(g,h){h.content=d._doScImage(h.content)});a.onPostProcess.add(function(g,h){if(h.get){h.content=d._getScImage(h.content)}});a.onInit.add(function(g){tinymce.dom.Event.add(g.getWin(),"scroll",function(h){d._hideButtons()});tinymce.dom.Event.add(g.getBody(),"dragstart",function(h){d._hideButtons()})})},_doScImage:function(b){var a=this;return b.replace(a.regex,function(e,d,f){return'<img src="'+a.shortcodes[d].image+'" id="vscImage'+(a.counter++)+"-"+d+'" class="mceItem jpbVisualShortcode" title="'+d+tinymce.DOM.encode(f)+'" />'})},_getScImage:function(b){function a(c,d){d=new RegExp(d+'="([^"]+)"',"g").exec(c);return d?tinymce.DOM.decode(d[1]):""}return b.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(e,d){var c=a(d,"class");if(c.indexOf("jpbVisualShortcode")!=-1){return"<p>["+tinymce.trim(a(d,"title"))+"]</p>"}return e})},_buildRegex:function(c){var b=this,a="";a="\\[("+c.join("|")+")(( [^\\]]+)*)\\]";b.regex=new RegExp(a,"gi")},_hideButtons:function(){tinymce.DOM.hide("jpb_vscbuttons");tinymce.DOM.hide("jpb_vscbutton")},_createButtons:function(){var c=this,a=tinyMCE.activeEditor,e=tinyMCE.DOM,d,b,f;e.remove("jpb_vscbuttons");e.remove("jpb_vscbutton");e.add(document.body,"div",{id:"jpb_vscbuttons",style:"display:none;"});e.add(document.body,"div",{id:"jpb_vscbutton",style:"display:none;"});d=e.add("jpb_vscbuttons","img",{src:c.url+"/img/edit.png",id:"jpb_editshortcode",width:"24",height:"24",style:"margin:2px;"});tinymce.dom.Event.add(d,"mousedown",function(j){var h=tinyMCE.activeEditor,i=h.selection.getNode(),g=i.id.replace(/^vscImage\d+-(.+)$/,"$1");if(!g||undefined===c.shortcodes[g]||undefined===c.shortcodes[g].command){return}h.execCommand(c.shortcodes[g].command);c._hideButtons()});b=e.add("jpb_vscbuttons","img",{src:c.url+"/img/delete.png",id:"jpb_delshortcode",width:"24",height:"24",style:"margin:2px;"});f=e.add("jpb_vscbutton","img",{src:c.url+"/img/delete.png",id:"jpb_delshortcode2",width:"24",height:"24",style:"margin:2px;"});tinymce.dom.Event.add([b,f],"mousedown",function(j){var g=tinyMCE.activeEditor,i=g.selection.getNode(),h;if(i.nodeName=="IMG"&&g.dom.hasClass(i,"jpbVisualShortcode")){h=i.parentNode;g.dom.remove(i);g.execCommand("mceRepaint");c._hideButtons();g.selection.select(h);return false}})}});tinymce.PluginManager.add("visualshortcodes",tinymce.plugins.visualShortcodes)})();